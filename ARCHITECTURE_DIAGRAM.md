# 🎨 Визуальная схема работы системы управления профилями

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM BOT                              │
│                   (main.py)                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │   Команда /accounts               │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  get_all_accounts_from_env()      │
        │  • Читает ACCOUNT_N_PHONE         │
        │  • Читает ACCOUNT_N_SESSION       │
        │  • Читает ACCOUNT_N_PROXY         │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  create_accounts_keyboard()       │
        │  • Пагинация (5 шт/страница)      │
        │  • Кнопки навигации               │
        └───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│                   СПИСОК АККАУНТОВ                            │
│  [✅ Аккаунт 1] [✅ Аккаунт 2] ... [✅ Аккаунт 5]            │
│  [◀️ Назад] [📄 1/5] [Вперёд ▶️]                             │
└───────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            ▼                               ▼
    ┌──────────────┐              ┌──────────────┐
    │ CallbackQuery│              │   Пагинация  │
    │  "acc_1"     │              │  "acc_page_2"│
    └──────────────┘              └──────────────┘
            │                               │
            ▼                               ▼
    ┌──────────────┐              ┌──────────────┐
    │get_account_  │              │ Новая        │
    │   info()     │              │ страница     │
    └──────────────┘              └──────────────┘
            │
            ▼
┌───────────────────────────────────────────────────────────────┐
│                    МЕНЮ АККАУНТА                              │
│  📱 Телефон: +1234567890                                      │
│  ✅ Авторизован                                               │
│                                                               │
│  [📷 Аватарка]  [👤 Имя]  [📝 Био]                           │
│  [◀️ Назад]  [🏠 Главное меню]                               │
└───────────────────────────────────────────────────────────────┘
            │
    ┌───────┴──────┬──────────────┐
    ▼              ▼              ▼
┌────────┐    ┌────────┐    ┌────────┐
│Аватарка│    │  Имя   │    │  Био   │
└────────┘    └────────┘    └────────┘
    │              │              │
    ▼              ▼              ▼
```

---

## 🔄 Поток изменения аватарки

```
Пользователь                    Бот                     Telegram API
    │                            │                            │
    │  1. Нажимает [📷]         │                            │
    ├──────────────────────────>│                            │
    │                            │                            │
    │  2. "Отправьте фото"      │                            │
    │<──────────────────────────┤                            │
    │                            │                            │
    │  3. Отправляет фото       │                            │
    ├──────────────────────────>│                            │
    │                            │                            │
    │                            │ 4. download_media()        │
    │                            │                            │
    │                            │ 5. save_temp_avatar()      │
    │                            │    /tmp/avatar_123.jpg     │
    │                            │                            │
    │  6. "✅ Фото выбрано"     │                            │
    │     [Применить] [Отмена]  │                            │
    │<──────────────────────────┤                            │
    │                            │                            │
    │  7. Нажимает [Применить]  │                            │
    ├──────────────────────────>│                            │
    │                            │                            │
    │                            │ 8. apply_account_changes() │
    │                            │                            │
    │                            │ 9. UploadProfilePhoto      │
    │                            ├───────────────────────────>│
    │                            │                            │
    │                            │ 10. ✅ Success             │
    │                            │<───────────────────────────┤
    │                            │                            │
    │                            │ 11. clear_user_state()     │
    │                            │     (удалить temp файл)    │
    │                            │                            │
    │  12. "✅ Аватарка         │                            │
    │       обновлена"          │                            │
    │<──────────────────────────┤                            │
    │                            │                            │
```

---

## 🔄 Поток изменения имени

```
Пользователь              Бот                    State Manager
    │                      │                           │
    │  1. Нажимает [👤]   │                           │
    ├────────────────────>│                           │
    │                      │                           │
    │                      │  2. user_states[id] =    │
    │                      │     {'state': 'waiting_  │
    │                      │      name', ...}          │
    │                      ├──────────────────────────>│
    │                      │                           │
    │  3. "Введите имя"   │                           │
    │<────────────────────┤                           │
    │                      │                           │
    │  4. "Алексей Смирнов"                          │
    ├────────────────────>│                           │
    │                      │                           │
    │                      │  5. Валидация (< 64 chars)
    │                      │                           │
    │                      │  6. Разбивка по пробелу  │
    │                      │     first = "Алексей"    │
    │                      │     last = "Смирнов"     │
    │                      │                           │
    │                      │  7. Сохранить в state    │
    │                      ├──────────────────────────>│
    │                      │                           │
    │  8. "Превью:        │                           │
    │     Имя: Алексей    │                           │
    │     Фамилия: Смирнов│                           │
    │     [Применить]"    │                           │
    │<────────────────────┤                           │
    │                      │                           │
    │  9. [Применить]     │                           │
    ├────────────────────>│                           │
    │                      │                           │
    │                      │  10. apply_account_      │
    │                      │      changes()           │
    │                      │                           │
    │  11. "✅ Обновлено" │                           │
    │<────────────────────┤                           │
    │                      │                           │
```

---

## 🗂️ Структура State Management

```
┌───────────────────────────────────────────────────────────┐
│                    self.user_states                        │
└───────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴──────────────────┐
        ▼                                      ▼
┌─────────────────┐                  ┌─────────────────┐
│  user_id: 123   │                  │ user_id: 456    │
└─────────────────┘                  └─────────────────┘
        │                                      │
        ▼                                      ▼
┌─────────────────────────────────┐  ┌─────────────────────┐
│ state: "waiting_avatar"         │  │ state: "waiting_bio"│
│ account_num: 1                  │  │ account_num: 5      │
│ data: {                         │  │ data: {             │
│   temp_avatar: "/tmp/av.jpg"    │  │   bio: "Text..."    │
│ }                               │  │ }                   │
└─────────────────────────────────┘  └─────────────────────┘
```

---

## 📦 Структура данных аккаунтов

```
┌─────────────────────────────────────────────────────────────┐
│              ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ                           │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        ▼                                       ▼
┌──────────────────┐                  ┌──────────────────┐
│  ACCOUNT_1_*     │                  │  ACCOUNT_2_*     │
│  • PHONE         │                  │  • PHONE         │
│  • SESSION       │                  │  • SESSION       │
│  • PROXY         │                  │  • PROXY         │
└──────────────────┘                  └──────────────────┘
        │                                       │
        └───────────────────┬───────────────────┘
                            ▼
        ┌───────────────────────────────────┐
        │  get_all_accounts_from_env()      │
        │  Возвращает:                      │
        │  [(num, phone, session, proxy)]   │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  account_cache (кеш)              │
        │  {'accounts': [...]}              │
        └───────────────────────────────────┘
```

---

## 🎯 Жизненный цикл операции

```
START
  │
  ▼
┌─────────────────────────┐
│ Пользователь вводит     │
│ /accounts               │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ Загрузка аккаунтов      │
│ из env                  │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ Создание клавиатуры     │
│ с пагинацией            │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ Отправка сообщения      │
│ со списком              │
└─────────────────────────┘
  │
  ▼
┌─────────────────────────┐
│ Ожидание выбора         │
│ (CallbackQuery)         │
└─────────────────────────┘
  │
  ├──> [Пагинация] ──> Новая страница
  │
  ├──> [Аккаунт] ──> Меню аккаунта
  │                      │
  │                      ├──> [Аватарка] ──> waiting_avatar
  │                      │                      │
  │                      │                      ▼
  │                      │                   [Фото]
  │                      │                      │
  │                      │                      ▼
  │                      │                   [Превью]
  │                      │                      │
  │                      │                      ▼
  │                      │                   [Применить]
  │                      │                      │
  │                      │                      ▼
  │                      │                   [API Call]
  │                      │                      │
  │                      │                      ▼
  │                      │                   [Очистка]
  │                      │                      │
  │                      │                      ▼
  │                      │                   [✅ Готово]
  │                      │
  │                      ├──> [Имя] ──> waiting_name ──> ...
  │                      │
  │                      └──> [Био] ──> waiting_bio ──> ...
  │
  └──> [Главное меню] ──> Выход
```

---

## 🔐 Безопасность и очистка

```
┌─────────────────────────────────────────────────────────┐
│              ЖИЗНЕННЫЙ ЦИКЛ ДАННЫХ                       │
└─────────────────────────────────────────────────────────┘

Создание состояния:
    user_states[user_id] = {...}
           │
           ▼
    Временные данные (temp_avatar, bio, etc.)
           │
           ▼
    Применение изменений
           │
           ▼
    clear_user_state(user_id)
           │
           ├──> Удаление temp файлов
           │       (os.remove)
           │
           └──> Удаление из user_states
                   (del user_states[user_id])

Триггеры очистки:
    • Успешное применение
    • Отмена пользователем
    • Переход в главное меню
    • Ошибка операции
```

---

## 📊 Производительность и оптимизация

```
┌─────────────────────────────────────────────────────────┐
│              ОПТИМИЗАЦИИ СИСТЕМЫ                         │
└─────────────────────────────────────────────────────────┘

1. Кеширование аккаунтов:
   ┌──────────────────────┐
   │ При первом запросе:  │
   │ • Чтение из env      │
   │ • Парсинг прокси     │
   │ • Сохранение в кеш   │
   └──────────────────────┘
   ┌──────────────────────┐
   │ При последующих:     │
   │ • Чтение из кеша     │
   │ • Без парсинга       │
   └──────────────────────┘

2. Асинхронность:
   ┌──────────────────────┐
   │ Все операции async   │
   │ • Нет блокировок     │
   │ • Параллельные юзеры │
   └──────────────────────┘

3. Пагинация:
   ┌──────────────────────┐
   │ Показ только 5 шт    │
   │ • Меньше данных      │
   │ • Быстрее загрузка   │
   └──────────────────────┘

4. Валидация:
   ┌──────────────────────┐
   │ Проверка до API      │
   │ • Экономия запросов  │
   │ • Меньше ошибок      │
   └──────────────────────┘
```

---

## 🎨 UI Flow (последовательность экранов)

```
Screen 1: Список аккаунтов
┌────────────────────────────┐
│ 🔐 АККАУНТЫ (25)           │
│                            │
│ [✅ Аккаунт 1 - +1234...]  │
│ [✅ Аккаунт 2 - +0987...]  │
│ [✅ Аккаунт 3 - +1112...]  │
│ [✅ Аккаунт 4 - +4445...]  │
│ [✅ Аккаунт 5 - +7778...]  │
│                            │
│ [◀️ Назад] [1/5] [▶️]     │
│ [🏠 Главное меню]          │
└────────────────────────────┘
        │
        ▼ (выбор аккаунта)
        
Screen 2: Меню аккаунта
┌────────────────────────────┐
│ 🔐 АККАУНТ #1              │
│ 📱 +1234567890             │
│ ✅ Авторизован             │
│                            │
│ 👤 Иван Петров             │
│ 📝 Developer 🌐            │
│                            │
│ [📷 Аватарка]              │
│ [👤 Имя и Фамилия]         │
│ [📝 О себе (Био)]          │
│ [◀️ Назад]                │
│ [🏠 Главное меню]          │
└────────────────────────────┘
        │
        ▼ (выбор действия)
        
Screen 3a: Загрузка аватарки
┌────────────────────────────┐
│ 📷 АВАТАРКА                │
│                            │
│ Аккаунт: +1234567890       │
│                            │
│ Отправьте фото             │
│ (jpg, png)                 │
│                            │
│ [❌ Отмена]                │
└────────────────────────────┘
        │
        ▼ (отправка фото)
        
Screen 4a: Подтверждение
┌────────────────────────────┐
│ ✅ ФОТО ВЫБРАНО            │
│                            │
│ Аккаунт: +1234567890       │
│                            │
│ Применить это фото?        │
│                            │
│ [✅ Применить] [❌ Отмена] │
└────────────────────────────┘
        │
        ▼ (применение)
        
Screen 5a: Результат
┌────────────────────────────┐
│ 🔐 АККАУНТ #1              │
│                            │
│ ✅ Аватарка обновлена      │
│                            │
│ [📷 Аватарка]              │
│ [👤 Имя и Фамилия]         │
│ [📝 О себе (Био)]          │
│ [◀️ Назад]                │
└────────────────────────────┘
```

---

**Эта схема показывает полную архитектуру и потоки работы системы! 🎨**
