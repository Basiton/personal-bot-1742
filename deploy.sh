#!/bin/bash
# ะกะบัะธะฟั ะฑะตะทะพะฟะฐัะฝะพะณะพ ะดะตะฟะปะพั ะฑะพัะฐ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน ะฑะพัะฐ..."

# 1. ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต (ะตััั bot_data.json)
if [ ! -f "bot_data.json" ]; then
    echo "โ ะะจะะะะ: bot_data.json ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "โ ะญัะพ ะฟะตัะฒัะน ะทะฐะฟััะบ? ะะพัััะฐะฝะพะฒะธัะต ะธะท ะฑัะบะฐะฟะฐ ะธะปะธ ะฐะฒัะพัะธะทัะนัะต ะฐะบะบะฐัะฝัั."
    exit 1
fi

# 2. ะกะพะทะดะฐัะผ ะฑัะบะฐะฟ ะฟะตัะตะด ะพะฑะฝะพะฒะปะตะฝะธะตะผ
BACKUP_NAME="bot_data.json.deploy_backup_$(date +%Y%m%d_%H%M%S)"
echo "๐พ ะกะพะทะดะฐัะผ ะฑัะบะฐะฟ: $BACKUP_NAME"
cp bot_data.json "$BACKUP_NAME"

# 3. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑะพัะฐ
echo "โธ๏ธ  ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑะพัะฐ..."
pkill -f "python3 main.py" || echo "ะะพั ะฝะต ะทะฐะฟััะตะฝ"
sleep 2

# 4. ะะฑะฝะพะฒะปัะตะผ ะบะพะด
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท Git..."
git fetch origin
git reset --hard origin/main  # ะัััะบะธะน ัะฑัะพั ะบ ัะดะฐะปัะฝะฝะพะน ะฒะตััะธะธ
# ะะปััะตัะฝะฐัะธะฒะฐ: git pull (ะตัะปะธ ัะฒะตัะตะฝั ะฒ ะปะพะบะฐะปัะฝัั ะธะทะผะตะฝะตะฝะธัั)

# 5. ะัะพะฒะตััะตะผ ัะตะปะพััะฝะพััั bot_data.json
echo "๐ ะัะพะฒะตััะตะผ ัะตะปะพััะฝะพััั ะดะฐะฝะฝัั..."
python3 -c "import json; json.load(open('bot_data.json'))" || {
    echo "โ bot_data.json ะฟะพะฒัะตะถะดัะฝ! ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธะท ะฑัะบะฐะฟะฐ..."
    cp "$BACKUP_NAME" bot_data.json
}

# 6. ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ
echo "โถ๏ธ  ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ..."
nohup python3 main.py > bot_logs.txt 2>&1 &
BOTPID=$!
echo "โ ะะพั ะทะฐะฟััะตะฝ (PID: $BOTPID)"

# 7. ะัะพะฒะตััะตะผ ะปะพะณะธ
sleep 3
echo ""
echo "๐ ะะพัะปะตะดะฝะธะต ัััะพะบะธ ะปะพะณะพะฒ:"
tail -20 bot_logs.txt

echo ""
echo "โ ะะตะฟะปะพะน ะทะฐะฒะตัััะฝ!"
echo "๐ก ะัะพะฒะตัััะต ะปะพะณะธ: tail -f bot_logs.txt"
echo "๐ก ะัะพะฒะตัััะต ััะฐััั ะฒ Telegram: /listaccounts"
